<template>
    <div class="container ivu-card" :class="currentTheme">
      <div class="container ivu-card">
      <!-- ÈáçÊûÑÂêéÁöÑÂ∏ÉÂ±ÄÁªìÊûÑ -->
      <div class="main-layout">
          <!-- Êñ∞Â¢ûÂÜÖÂÆπÁâáÊÆµÈù¢Êùø -->
          <Card class="snippet-panel">
            <template #title>
              <div class="panel-header">
                <div class="panel-title">
                  <Icon type="ios-list"/><span style="margin-left:8px">ÂÜÖÂÆπÁâáÊÆµ</span>
                </div>
                <!-- ‰∏ªÈ¢òÊåâÈíÆÁßªÂà∞Ê†áÈ¢òÂè≥‰æß -->
                <Button @click="toggleTheme" class="theme-btn">
                  <Icon :type="themeIcon"></Icon>
                </Button>
              </div>
            </template>
              <List border>
                <ListItem 
                  v-for="(item, index) in contentSnippets" 
                  :key="index"
                  @click.native="insertSnippet(index)"
                  class="snippet-item">
                  <div style="display: flex; align-items: center">
                      <Icon :type="item.icon" style="margin-right:8px"/>
                      <span class="snippet-title">{{ item.title }}</span>
                  </div>
                </ListItem>
              </List>
          </Card>
          <!-- ÁºñËæëÂô®Âå∫Âüü -->
          <div class="editor-wrapper">
            <!-- Âè≥‰æßÁºñËæëÂå∫Âüü -->
            <div class="right-panel">
                <div class="toolbar ivu-card ivu-card-bordered">
                  <Button @click="insertSyntax('bold')" title="Âä†Á≤ó">
                      <Icon type="md-radio-button-on"/>
                  </Button>
                  <Button @click="insertSyntax('italic')" title="Êñú‰Ωì">
                      <Icon type="md-remove"/>
                  </Button>
                    <Dropdown @on-click="handleHeading" transfer>
                      <Button title="Ê†áÈ¢ò">
                          <Icon type="md-text"/>
                      </Button>
                        <DropdownMenu slot="list">
                            <DropdownItem v-for="n in 6" :key="n" :name="n">H{{n}}</DropdownItem>
                        </DropdownMenu>
                    </Dropdown>
                    <Button @click="insertSyntax('link')" title="ÈìæÊé•">
                        <Icon type="ios-link"/>
                    </Button>
                    <Button @click="insertSyntax('code')" title="‰ª£Á†ÅÂùó">
                        <Icon type="ios-code"/>
                    </Button>
                    <Button @click="insertSyntax('strike')" title="Âà†Èô§Á∫ø">
                        <Icon type="md-remove"/>
                    </Button>
                    <Button @click="insertSyntax('hr')" title="Ê∞¥Âπ≥Á∫ø">
                        <Icon type="md-remove"/>
                    </Button>
                    <Dropdown transfer>
                      <Button title="ÂàóË°®">
                          <Icon type="ios-list"/>
                      </Button>
                        <DropdownMenu slot="list">
                            <DropdownItem @click.native="insertSyntax('ulist')">Êó†Â∫èÂàóË°®</DropdownItem>
                            <DropdownItem @click.native="insertSyntax('olist')">ÊúâÂ∫èÂàóË°®</DropdownItem>
                            <DropdownItem @click.native="insertSyntax('task')">‰ªªÂä°ÂàóË°®</DropdownItem>
                        </DropdownMenu>
                    </Dropdown>
                    <Button @click="insertTable" title="Ë°®Ê†º">
                        <Icon type="md-grid"/>
                    </Button>
                    <Button @click="insertSyntax('image')" title="ÊèíÂÖ•ÂõæÁâá">
                        <Icon type="md-image"/>
                    </Button>
                    <Button @click="insertSyntax('quote')" title="ÂºïÁî®Âùó">
                        <Icon type="md-quote"/>
                    </Button>
                    <Button @click="downloadMD" title="‰∏ãËΩΩMDÊñá‰ª∂">
                        <Icon type="md-download"/>
                    </Button>
                    <Button @click="exportPDF" title="ÂØºÂá∫PDF">
                        <Icon type="md-document"/>
                    </Button>
                </div>
                <div class="edit-preview-container">
                    <div class="editor-box">
                        <Input 
                            v-model="markdownContent" 
                            type="textarea"
                            class="ivu-input-wrapper"
                            placeholder="ËæìÂÖ•MarkdownÂÜÖÂÆπ..."
                            :rows="25"
                            @on-change="updatePreview"
                            ref="editor"/>
                    </div>
                    
                    <div class="preview-box">
                        <div class="preview-content" v-html="parsedMarkdown"></div>
                    </div>
                </div>
            </div>
          </div>
      </div>
    </div>
    </div>
  </template>
  
  <script>
  import marked from 'marked'
  import DOMPurify from 'dompurify';
  import html2pdf from 'html2pdf.js';  // ÂØºÂÖ•html2pdf.js
  
  export default {
    name: 'Resume',
    data() {
      return {
        isDarkTheme: false,
        // Êñ∞Â¢ûÂÜÖÂÆπÁâáÊÆµÊï∞ÊçÆ
        contentSnippets: [
          {
            title: 'ËÅîÁ≥ªÊñπÂºè',
            icon: 'ios-call',  // ‚úÖ Ê≠£Á°Æ
            content: `## üìû ËÅîÁ≥ªÊñπÂºè \n\n- ÊâãÊú∫Ôºö138-XXXX-XXXX\n- ÈÇÆÁÆ±Ôºözhangsan@example.com\n`
          },
          {
            title: '‰∏™‰∫∫‰ø°ÊÅØ', 
            icon: 'ios-person',  // ‚úÖ Ê≠£Á°Æ
            content: `## üßë ‰∏™‰∫∫‰ø°ÊÅØ\n\n- Âπ¥ÈæÑÔºö28\n- Â≠¶ÂéÜÔºöÊú¨Áßë\n- Â∑•‰ΩúÂπ¥ÈôêÔºö5Âπ¥\n`
          },
          {
            title: 'ÊïôËÇ≤ËÉåÊôØ',
            icon: 'ios-school',  // ‚úÖ Ê≠£Á°Æ
            content: `## üéì ÊïôËÇ≤ËÉåÊôØ\n\n**XXÂ§ßÂ≠¶** \nËÆ°ÁÆóÊú∫ÁßëÂ≠¶‰∏éÊäÄÊúØ | Á°ïÂ£´\n2018.09 - 2021.06\n`
          },
          {
            title: 'Â∑•‰ΩúÁªèÂéÜ',
            icon: 'ios-briefcase',  // ‚úÖ Ê≠£Á°Æ
            content: `## üíº Â∑•‰ΩúÁªèÂéÜ\n\n**XXÁßëÊäÄÊúâÈôêÂÖ¨Âè∏** \nÂÖ®Ê†àÂ∑•Á®ãÂ∏à | 2021.07 - Ëá≥‰ªä\n- Ë¥üË¥£ÂâçÂêéÁ´ØÊû∂ÊûÑËÆæËÆ°\n- ‰∏ªÂØºÂºÄÂèëXXÁÆ°ÁêÜÁ≥ªÁªü\n- ÊäÄÊúØÂõ¢ÈòüÁÆ°ÁêÜ‰∏éÂüπËÆ≠\n`
          },
          {
            title: 'È°πÁõÆÁªèÈ™å',
            icon: 'ios-folder',  // ‚úÖ Ê≠£Á°Æ
            content: `## üöÄ È°πÁõÆÁªèÈ™å\n\n**XXÁÆ°ÁêÜÁ≥ªÁªü**\n- ÊäÄÊúØÊ†àÔºöVue3 + Node.js + MySQL\n- Ê†∏ÂøÉÂäüËÉΩÔºöÊùÉÈôêÁÆ°ÁêÜ„ÄÅÊï∞ÊçÆÂàÜÊûêÊ®°Âùó\n- ÊàêÊûúÔºöÊèêÂçáËøêËê•ÊïàÁéá40%\n`
          },
          {
            title: '‰∏ì‰∏öÊäÄËÉΩ',
            icon: 'ios-hammer',  // ‚ö†Ô∏è Â∫îÊîπ‰∏∫ ios-hammer-outline
            content: `## üîß ‰∏ì‰∏öÊäÄËÉΩ\n- Á≤æÈÄöVueÂÖ®ÂÆ∂Ê°∂ÂºÄÂèë\n- ÁÜüÊÇâÂæÆÊúçÂä°Êû∂ÊûÑËÆæËÆ°\n- ÊéåÊè°DevOpsÂÖ®ÊµÅÁ®ã\n`
          }
        ],
        markdownContent: '',
        parsedMarkdown: ''
      }
    },
    filters: {
      trimPreview(content) {
        const validLine = content.split('\n').find(line => line.trim());
        return validLine ? validLine.substring(0, 40).trim() : '';
      }
    },
    computed: {
      currentTheme() {
        return this.isDarkTheme ? 'dark-theme' : 'light-theme'
      },
      themeIcon() {
        return this.isDarkTheme ? 'ios-sunny' : 'ios-moon'
      }
    },
    mounted() {
      this.updatePreview();
    },
    methods: {
          async exportPDF() {
            const element = document.createElement('div');
            element.innerHTML = this.parsedMarkdown;
            element.className = 'preview-content pdf-export'; // ÁªßÊâøÈ¢ÑËßàÊ†∑Âºè
            
            const opt = {
                margin:       10,
                filename:     `resume_${new Date().getTime()}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, logging: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            await html2pdf().set(opt).from(element).save();
        },
        downloadMD() {
          const blob = new Blob([this.markdownContent], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `resume_${new Date().getTime()}.md`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
      },
        // Êñ∞Â¢ûÁâáÊÆµÊèíÂÖ•ÊñπÊ≥ï
      insertSnippet(index) {
        const snippet = this.contentSnippets[index].content;
        const editor = this.$refs.editor.$el.querySelector('textarea');
        const start = editor.selectionStart;
        
        // Âú®ÂΩìÂâç‰ΩçÁΩÆÁõ¥Êé•ÊèíÂÖ•ÂÆåÊï¥ÁâáÊÆµÔºà‰øùÁïôÂéüÊç¢Ë°åÊ†ºÂºèÔºâ
        this.markdownContent = 
        this.markdownContent.slice(0, start) +
        snippet +  // ÁßªÈô§ÂâçÂêéÊç¢Ë°åÁ¨¶
        this.markdownContent.slice(start);
        
        this.$nextTick(() => {
        // Ëá™Âä®ÊªöÂä®Âà∞ÊèíÂÖ•‰ΩçÁΩÆ
        editor.scrollTop = editor.scrollHeight;
        editor.focus();
        this.updatePreview();
        });
      },
      toggleTheme() {
        this.isDarkTheme = !this.isDarkTheme
      },
      parseMarkdown(text) {
        return DOMPurify.sanitize(marked.parse(text))
      },
      updatePreview() {
        this.parsedMarkdown = this.parseMarkdown(this.markdownContent)
      },
      insertTable() {
        const table = 
        `| Header1 | Header2 | Header3 |
        |---------|---------|---------|
        | Cell1   | Cell2   | Cell3   |
        | Cell4   | Cell5   | Cell6   |\n\n`;
                this.insertAtCursor(table);
            },
        insertAtCursor(content) {
            const editor = this.$refs.editor.$el.querySelector('textarea');
            const start = editor.selectionStart;
            this.markdownContent = 
                this.markdownContent.slice(0, start) +
                content +
                this.markdownContent.slice(start);
            this.$nextTick(() => {
                editor.focus();
                editor.setSelectionRange(start + content.length, start + content.length);
            });
        },
      insertSyntax(type) {
        const editor = this.$refs.editor.$el.querySelector('textarea');
        const startPos = editor.selectionStart;
        const endPos = editor.selectionEnd;
        const selectedText = editor.value.substring(startPos, endPos);
        
        const syntaxMap = {
            bold: { wrap: '**${text}**', placeholder: 'Âä†Á≤óÊñáÂ≠ó' },  // Â¢ûÂä†ÂÆåÊï¥ÂåÖË£πËØ≠Ê≥ï
            italic: { wrap: '_${text}_', placeholder: 'Êñú‰ΩìÊñáÂ≠ó' }, // Â¢ûÂä†‰∏ãÂàíÁ∫øÂåÖË£π
            link: { wrap: '[${text}](url)', placeholder: 'ÈìæÊé•ÊñáÂ≠ó' },
            code: { wrap: '```\n${text}\n```', placeholder: '‰ª£Á†ÅÂÜÖÂÆπ' },
            strike: { wrap: '~~${text}~~', placeholder: 'Âà†Èô§Á∫øÊñáÂ≠ó' },
            hr: { wrap: '\n---\n', placeholder: '' },
            ulist: { wrap: '- ${text}\n', placeholder: 'ÂàóË°®È°π' },
            olist: { wrap: '1. ${text}\n', placeholder: 'ÂàóË°®È°π' },
            task: { wrap: '- [ ] ${text}\n', placeholder: '‰ªªÂä°È°π' },
            image: { wrap: '![${text}](url)', placeholder: 'ÂõæÁâáÊèèËø∞' },
            quote: { wrap: '> ${text}\n', placeholder: 'ÂºïÁî®ÂÜÖÂÆπ' }
        };
        
        const { wrap, placeholder } = syntaxMap[type];
        const [prefix, suffix] = wrap.split('${text}');
        const newText = prefix + (selectedText || placeholder) + suffix;  // Áé∞Âú®ÂèØ‰ª•Ê≠£Á°ÆÊãºÊé•ÂâçÁºÄÂêéÁºÄ
        
        this.markdownContent = 
            editor.value.substring(0, startPos) +
            newText +
            editor.value.substring(endPos);
            
            this.$nextTick(() => {
                const newPos = startPos + (selectedText ? 0 : prefix.length);
                editor.setSelectionRange(
                    newPos, 
                    newPos + (selectedText ? selectedText.length : placeholder.length)
                );
                editor.focus();
            });
        },
        handleHeading(level) {
            const header = '#'.repeat(level) + ' ';
            this.markdownContent = this.markdownContent + '\n' + header;
            this.$refs.editor.focus();
        }
    }
  }
  </script>
  
<style scoped>
/* Êñ∞Â¢û‰∏ªÈ¢òÊ†∑Âºè */
.dark-theme {
  background: #2d2d2d;
  color: #fff;
}

.dark-theme .ivu-card,
.dark-theme .editor-box,
.dark-theme .preview-box {
  background: #1a1a1a;
  border-color: #333;
}

.dark-theme .snippet-item:hover {
  background: #333 !important;
}

/* ÊöóÈªëÊ®°ÂºèÈÄÇÈÖç */
.dark-theme .toolbar {
  background: #2d2d2d;
  border-color: #444;
  
  .ivu-btn {
    background: #3a3a3a;
    border-color: #555;
    color: #fff;
    
    &:hover {
      background: #484848;
    }
  }
}
/* Êñ∞Â¢ûÂÆπÂô®Â∏ÉÂ±Ä */
.main-layout {
  display: grid;
  grid-template-columns: 200px 1fr;
  gap: 12px; /* Áº©Â∞èÈó¥Ë∑ù */
  height: calc(100vh - 80px); /* Â¢ûÂä†Â∫ïÈÉ®ÁïôÁôΩ */
}
.container {
  height: 100vh;
  margin: 0;
  padding: 0; /* ÁßªÈô§ÂÆπÂô®ÂÜÖËæπË∑ù */
}
/* Ê†áÈ¢òÂå∫ÂüüÂ∏ÉÂ±Ä */
.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 8px; /* ÂáèÂ∞ëÂÜÖËæπË∑ù */
}
/* ‰∏ªÈ¢òÊåâÈíÆÊ†∑Âºè */
.theme-btn {
  padding: 4px 8px !important;
  height: 28px;
  ::v-deep i {
    font-size: 14px;
  }
}
/* Ë∞ÉÊï¥ÂêéÁöÑÁºñËæëÂô®ÂÆπÂô® */
.editor-wrapper {
  display: grid;
  grid-template-rows: auto 1fr;
  height: 100%;
  padding-right: 12px; /* ÂáèÂ∞ëÂè≥‰æßÈó¥Ë∑ù */
}

/* ‰ºòÂåñÂêéÁöÑÂ∑¶‰æßÈù¢Êùø */
.snippet-panel {
  ::v-deep {
    .ivu-list-item {
      padding: 12px 16px;
      transition: all 0.2s;
      cursor: pointer;
      &:hover {
        background: #f5f5f6;
        transform: translateX(4px);
      }
      /* Êñ∞Â¢ûÁÇπÂáªÊïàÊûú */
      &:active {
        transform: translateX(8px);
        transition: all 0.1s;
      }
      .snippet-title {
        font-weight: 500;
        line-height: 1.4;
      }
    }
  }
  ::v-deep .ivu-card-head {
    padding: 8px 12px;
  }
  ::v-deep .ivu-card-body {
    padding: 0;
  }
}

.right-panel {
  display: grid;
  grid-template-rows: auto 1fr; /* Êîπ‰∏∫Ëá™Âä®ÈÄÇÂ∫îÈ´òÂ∫¶ */
  gap: 16px;
  height: 100%; /* Êîπ‰∏∫Â°´ÂÖÖÂâ©‰ΩôÁ©∫Èó¥ */
  margin-top: -8px; /* ÊäµÊ∂àÁà∂ÂÆπÂô®gapÁöÑÈ°∂ÈÉ®Èó¥Ë∑ù */
  overflow: visible;
}


.edit-preview-container {
  display: grid;
  grid-template-rows: 1fr; /* Á°Æ‰øùÂÜÖÈÉ®ÂÖÉÁ¥†ÊíëÊª°È´òÂ∫¶ */
  grid-template-columns: 1.2fr 1fr;
  gap: 16px;
  height: 100%;  /* Êîπ‰∏∫ÁôæÂàÜÊØîÈ´òÂ∫¶ */
  min-height: 500px;
  overflow: visible; /* Êñ∞Â¢ûÊ∫¢Âá∫ÊéßÂà∂ */
  position: relative;
  z-index: 0; /* ‰øùËØÅÁºñËæëÂô®Âú®Â∫ïÂ±Ç*/
}

.editor-box {
  border: 1px solid #e8eaec;
  border-radius: 8px;
  background: #fff;
  box-shadow: 0 2px 8px rgba(28, 31, 35, 0.05);
  padding: 12px;
  height: 100%;
  overflow: hidden; /* ‰øùËØÅÂÜÖÈÉ®ÊªöÂä® */
}

.preview-box {
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(28, 31, 35, 0.05);
  height: calc(100vh - 220px); /* Âõ∫ÂÆöÈ´òÂ∫¶ */
  overflow-y: auto; /* Ê∑ªÂä†ÂûÇÁõ¥ÊªöÂä® */
}

.ivu-input-wrapper {
  height: 100% !important;  /* ÊÅ¢Â§çÂÆåÊï¥È´òÂ∫¶ */
  overflow-y: hidden !important;  /* Á¶ÅÁî®ÂÆπÂô®ÊªöÂä® */
  border: none !important;
}
/* Ë∞ÉÊï¥ÊñáÊú¨ÂüüÊ†∑Âºè */
/* ÊñáÊú¨ÂüüËá™Ë∫´Ê∑ªÂä†ÊªöÂä® */
.ivu-input-wrapper textarea {
  height: 100% !important;
  overflow-y: auto !important;  /* ÊñáÊú¨ÂüüÂÜÖÈÉ®ÊªöÂä® */
  resize: none;
  border: none !important;
  box-shadow: none !important;
  padding: 12px;  /* Â¢ûÂä†ÂÜÖËæπË∑ù */
}
.preview-content {
  height: 100% !important;
  min-height: 300px;
}

.preview-content {
  padding: 24px;
  font-size: 14px;
  line-height: 1.8;
  text-align: left; /* Êñ∞Â¢ûÂ∑¶ÂØπÈΩêÂ±ûÊÄß */
  min-height: min-content; /* Á°Æ‰øùÂÜÖÂÆπÊíëÂºÄ */
  h1, h2 {
    margin: 1em 0 0.5em;
    padding-bottom: 0.3em;
    border-bottom: 1px solid #eee;
  }
}

.toolbar {
  position: sticky; 
  transform: translateZ(0); 
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  padding: 6px 12px;
  gap: 8px; /* ‰ΩøÁî®Èó¥Ë∑ù‰ª£Êõømargin */
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(28, 31, 35, 0.08);
  overflow-x: auto; /* Ê∑ªÂä†Ê∞¥Âπ≥ÊªöÂä® */
  white-space: nowrap;

  /* Êñ∞Â¢ûÊªöÂä®Êù°Ê†∑Âºè*/
  &::-webkit-scrollbar {
    height: 4px;
    background: transparent;
  }
  &::-webkit-scrollbar-thumb {
    background: #e8eaec;
    border-radius: 2px;
  }
  .ivu-dropdown {
    position: static; 
  }

  .ivu-btn {
    height: 32px;
    padding: 0 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    border: 1px solid #e8eaec;
    
    &:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(28, 31, 35, 0.1);
    }
    
    i {
      margin-right: 4px;
      vertical-align: middle;
      font-size: 18px; /* ÊîæÂ§ßÂõæÊ†á */
      margin: 0; /* ÁßªÈô§ÂõæÊ†áÂè≥ËæπË∑ù */
    }
  }
}

/* // Êñ∞Â¢û‰∏ãÊãâËèúÂçïÂ±ÇÁ∫ßË∞ÉÊï¥ */
.ivu-select-dropdown {
  position: fixed !important;  /* Êîπ‰∏∫fixedÂÆö‰Ωç*/
  z-index: 9999 !important; 
  transform: translateZ(0);
  will-change: transform; 
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}
/* Êñ∞Â¢ûÂìçÂ∫îÂºèÂ§ÑÁêÜ */
@media (max-width: 768px) {
  .main-layout {
    grid-template-columns: 1fr;
    height: auto;
  }
  
  .snippet-panel {
    height: 300px;
    margin-bottom: 20px;
  }
}
html, body {
  height: 100%;
}
.pdf-export {
    position: absolute;
    left: -9999px;
    width: 210mm !important; /* A4Á∫∏ÂÆΩÂ∫¶ */
    padding: 20mm !important;
    background: white !important;
    color: #000 !important;
}

.dark-theme .pdf-export {
    background: #fff !important;
    color: #000 !important;
}
</style>